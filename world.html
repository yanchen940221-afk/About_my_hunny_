<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>World</title>

  <!-- 建議：沿用你原本 style.css -->
  <link rel="stylesheet" href="./style.css?v=world5" />

  <style>
    /* ====== World screen layout ====== */
    body{
      margin:0;
      background:#000; /* 框架外黑色 */
    }

    .page{
      min-height:100vh;
      display:grid;
      place-items:center;
      padding:24px;
    }

    .gb{
      width:min(92vw, 520px);
      aspect-ratio: 160 / 144;
      border:10px solid #111;
      border-radius:14px;
      position:relative;
      overflow:hidden;
      background:#dce7c7;
      box-shadow: 0 18px 45px rgba(0,0,0,.35);
      image-rendering: pixelated;
    }

    /* 讓整個畫面更像 GB：顆粒 + 掃描線 + 輕微抖動 */
    @keyframes noiseShift{
      0%{ transform: translate(0,0); }
      25%{ transform: translate(1px,0); }
      50%{ transform: translate(0,1px); }
      75%{ transform: translate(-1px,0); }
      100%{ transform: translate(0,0); }
    }
    .overlay{
      pointer-events:none;
      position:absolute;
      inset:0;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(0,0,0,.06) 0px,
          rgba(0,0,0,.06) 1px,
          rgba(255,255,255,0) 2px,
          rgba(255,255,255,0) 4px
        ),
        radial-gradient(circle at 20% 30%, rgba(0,0,0,.06), rgba(0,0,0,0) 45%),
        radial-gradient(circle at 80% 60%, rgba(0,0,0,.05), rgba(0,0,0,0) 45%);
      mix-blend-mode:multiply;
      opacity:.55;
      animation: noiseShift .18s steps(2,end) infinite;
    }

    /* 上方血條/點點 */
    .hud{
      position:absolute;
      left:10px;
      right:10px;
      top:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-family: "Press Start 2P", monospace;
      font-size:10px;
      color:#081820;
      letter-spacing:.02em;
    }
    .hpBox{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .hpLine{
      width:56px;
      height:10px;
      border:2px solid #081820;
      background:transparent;
      position:relative;
    }
    .dots{
      display:flex;
      gap:3px;
      margin-left:4px;
    }
    .dot{
      width:6px;
      height:6px;
      border:2px solid #081820;
      border-radius:999px;
      background:#dce7c7;
    }
    .dot.on{
      background:#081820;
    }

    /* 人物區 */
    .arena{
      position:absolute;
      left:0; right:0;
      top:28px;
      bottom:46px; /* 留給對話框 */
    }
    .sprite{
      position:absolute;
      image-rendering: pixelated;
      filter: contrast(1.05);
      transform: translateZ(0);
    }

    /* 玩家：左下角（用背影更像原作；沒背影也可用同張） */
    .player{
      left:14px;
      bottom:4px;
      width:84px;   /* 你要更大可改 92/100 */
      height:auto;
    }

    /* 對手：右上角 */
    .rival{
      right:14px;
      top:2px;
      width:74px;
      height:auto;
    }

    /* 對話框 */
    .dialog{
      position:absolute;
      left:8px;
      right:8px;
      bottom:8px;
      height:38px;
      border:3px solid #081820;
      background:#dce7c7;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.35);
      padding:6px 10px 6px 10px;
      font-family: "Noto Sans TC", system-ui, -apple-system, "PingFang TC", "Microsoft JhengHei", sans-serif;
      color:#081820;
      letter-spacing:.04em;
      font-weight:800;
      display:flex;
      align-items:flex-start;
      line-height:1.15;
    }

    /* 打字區 */
    .text{
      font-size:14px;
      white-space:pre-wrap;
    }

    /* 右下角三角提示（打完才顯示） */
    .next{
      position:absolute;
      right:10px;
      bottom:10px;
      width:0; height:0;
      border-left:8px solid #081820;
      border-top:6px solid transparent;
      border-bottom:6px solid transparent;
      opacity:0;
    }
    .next.show{
      opacity:1;
      animation: blink 1s steps(2,end) infinite;
    }
    @keyframes blink { 50% { opacity:0; } }

    /* 使用者提示（可選） */
    .hintTop{
      position:absolute;
      right:10px;
      top:26px;
      font-size:10px;
      color:rgba(8,24,32,.7);
      font-family:"Press Start 2P", monospace;
    }
  </style>
</head>

<body>
  <div class="page">
    <main class="gb" id="screen" tabindex="0" aria-label="world screen">
      <!-- HUD -->
      <div class="hud">
        <div class="hpBox">
          <div class="hpLine"></div>
          <div class="dots" id="hpPlayer"></div>
        </div>

        <div class="hpBox">
          <div class="dots" id="hpRival"></div>
          <div class="hpLine"></div>
        </div>
      </div>

      <div class="hintTop">ENTER / CLICK</div>

      <!-- Arena -->
      <section class="arena">
        <!-- 玩家 -->
        <img class="sprite player" id="playerSprite" src="./assets/player.png" alt="player" />
        <!-- 對手 -->
        <img class="sprite rival" id="rivalSprite" src="./assets/rival.png" alt="rival" />
      </section>

      <!-- Dialog -->
      <section class="dialog" aria-label="dialog box">
        <div class="text" id="dialogText"></div>
        <div class="next" id="nextArrow" aria-hidden="true"></div>
      </section>

      <div class="overlay" aria-hidden="true"></div>
    </main>
  </div>

  <script>
    // ====== 0) 小工具 ======
    const $ = (id) => document.getElementById(id);
    const screen = $("screen");
    const textEl = $("dialogText");
    const arrow = $("nextArrow");

    // 取你前面輸入的暱稱（從 game.html 存的）
    const playerName = localStorage.getItem("playerName") || "玩家";

    // ====== 1) HP 點點（示意用） ======
    function renderDots(containerId, onCount, total=6){
      const box = $(containerId);
      box.innerHTML = "";
      for(let i=0;i<total;i++){
        const d = document.createElement("div");
        d.className = "dot" + (i < onCount ? " on" : "");
        box.appendChild(d);
      }
    }
    renderDots("hpPlayer", 6);
    renderDots("hpRival", 5);

    // ====== 2) 對話腳本（你可以自己改內容） ======
    const lines = [
      `${playerName}，你終於來了。`,
      `我等你很久了。`,
      `準備好了嗎？我們開始吧！`
    ];

    // ====== 3) 逐字打字系統 ======
    let lineIndex = 0;
    let charIndex = 0;
    let typing = false;
    let timer = null;

    const TYPE_SPEED = 28; // 越小越快（20~40 之間最像掌機）

    function stopTimer(){
      if(timer) clearTimeout(timer);
      timer = null;
    }

    function showArrow(show){
      arrow.classList.toggle("show", !!show);
    }

    function typeCurrentLine(){
      stopTimer();
      typing = true;
      showArrow(false);

      const line = lines[lineIndex];
      // 逐字輸出
      if(charIndex <= line.length){
        textEl.textContent = line.slice(0, charIndex);
        charIndex++;

        // 句尾標點稍微停久一點，像掌機節奏
        const lastChar = line[charIndex-1] || "";
        const extraPause = (lastChar === "。" || lastChar === "！" || lastChar === "？" || lastChar === "…" ) ? 80 : 0;

        timer = setTimeout(typeCurrentLine, TYPE_SPEED + extraPause);
      }else{
        // 打完
        typing = false;
        stopTimer();
        showArrow(true);
      }
    }

    function startLine(i){
      lineIndex = i;
      charIndex = 0;
      textEl.textContent = "";
      typeCurrentLine();
    }

    function advance(){
      // 正在打字 -> 直接補完
      if(typing){
        stopTimer();
        const line = lines[lineIndex];
        textEl.textContent = line;
        typing = false;
        showArrow(true);
        return;
      }

      // 已打完 -> 下一句
      if(lineIndex < lines.length - 1){
        startLine(lineIndex + 1);
      }else{
        // 最後一句結束：你可以在這裡接「進入地圖」或「下一段劇情」
        showArrow(false);
        textEl.textContent = "（對話結束，待續…）";
      }
    }

    // ====== 4) 操作：click 或 Enter ======
    screen.addEventListener("click", advance);
    window.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        e.preventDefault();
        advance();
      }
    });

    // 讓鍵盤操作更穩
    setTimeout(()=>screen.focus(), 50);

    // ====== 5) 啟動第一句 ======
    startLine(0);

    // ====== 6) 若你還沒做 rival.png：先用玩家圖頂著 ======
    $("rivalSprite").addEventListener("error", () => {
      $("rivalSprite").src = "./assets/player.png";
      // 對手可以翻轉一下看起來不同
      $("rivalSprite").style hookup;
    });

    // 小修：翻轉對手讓方向相對
    $("rivalSprite").style.transform = "scaleX(-1)";
  </script>
</body>
</html>
